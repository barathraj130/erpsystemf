<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ERP Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <link rel="stylesheet" href="/css/style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <!-- The script tag is now correctly placed in the head -->
  <script src="/js/script.js"></script>
</head>
<body>
  <div class="app-container">
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="logo">
          <i class="fas fa-cubes"></i>
          <h2>ERP System</h2>
        </div>
        <button class="sidebar-close-btn no-desktop" id="sidebarCloseBtn"><i class="fas fa-times"></i></button>
      </div>
      <nav class="sidebar-nav">
        <a href="#" class="nav-item active" data-section="dashboardAnalytics"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
        <a href="#" class="nav-item" data-section="customerManagementSection"><i class="fas fa-users"></i> Customers <span class="nav-item-count" id="navCustomerCount">0</span></a>
        <a href="#" class="nav-item" data-section="supplierManagementSection"><i class="fas fa-truck"></i> Suppliers <span class="nav-item-count" id="navSupplierCount">0</span></a>
        <a href="#" class="nav-item" data-section="inventoryManagementSection"><i class="fas fa-boxes-stacked"></i> Inventory <span class="nav-item-count" id="navInventoryCount">0</span></a>
        <a href="#" class="nav-item" data-section="invoiceManagementSection"><i class="fas fa-file-invoice-dollar"></i> Invoices <span class="nav-item-count" id="navInvoiceCount">0</span></a>
        <a href="#" class="nav-item" data-section="allTransactionsSection"><i class="fas fa-exchange-alt"></i> Transactions</a>
        <a href="#" class="nav-item" data-section="ledgersSection"><i class="fas fa-book"></i> Ledgers</a>
        <a href="#" class="nav-item" data-section="businessFinanceSection"><i class="fas fa-briefcase"></i> Business Finance</a>
        <a href="#" class="nav-item" data-section="reportsSection"><i class="fas fa-chart-pie"></i> Reports</a>
      </nav>
       <div class="sidebar-footer">
        <a href="#" class="nav-item"><i class="fas fa-cog"></i> Settings</a>
        <a href="#" class="nav-item" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a>
      </div>
    </aside>

    <div class="main-content-wrapper">
      <header class="app-header">
        <button class="menu-toggle" id="menuToggle"><i class="fas fa-bars"></i></button>
        <h1 id="mainHeaderText">Dashboard</h1>
        <div class="header-actions">
           <div class="search-bar-container">
            <input type="text" id="globalSearchInput" placeholder="Search..."/>
            <button class="search-btn" onclick="performGlobalSearch()"><i class="fas fa-search"></i></button>
          </div>
          <button class="action-icon-btn"><i class="fas fa-bell"></i><span class="badge">3</span></button>
          <button class="action-icon-btn"><i class="fas fa-question-circle"></i></button>
          <div class="user-profile">
            <img src="https://via.placeholder.com/40" alt="User Avatar" class="avatar"/>
            <div class="user-info">
              <span class="user-name">John Doe</span>
              <span class="user-role">Administrator</span>
            </div>
          </div>
           <button class="btn btn-primary btn-sm add-new-btn" id="headerAddButton"><i class="fas fa-plus"></i> New</button>
           <div class="add-new-dropdown" id="addNewDropdown">
                <a href="#" onclick="openUserModal(); closeAddNewDropdown(); return false;">New Customer</a>
                <a href="#" onclick="openLenderModal(null, 'Supplier'); closeAddNewDropdown(); return false;">New Supplier</a>
                <a href="#" onclick="openProductModal(); closeAddNewDropdown(); return false;">New Product</a>
                <a href="#" onclick="openInvoiceModal(); closeAddNewDropdown(); return false;">New Invoice</a>
                <a href="#" onclick="openTransactionModal(null); closeAddNewDropdown(); return false;">New Transaction</a>
           </div>
        </div>
      </header>

      <main class="main-content" id="mainContentArea">
        <div id="globalSearchResults" class="table-container" style="display:none;">
          <h3>Search Results</h3>
          <table id="globalSearchResultsTable">
              <thead></thead><tbody></tbody>
          </table>
        </div>

        <section class="app-section active-section" id="dashboardAnalytics">
          <div class="dashboard-header">
            <div>
              <h2>Welcome back!</h2>
              <p>Here's what's happening with your business today.</p>
            </div>
            <div class="dashboard-controls">
              <select id="dashboardPeriod" class="form-control-sm" onchange="updateDashboardPeriod()">
                <option value="this_month" selected>This Month</option>
                <option value="last_month">Last Month</option>
                <option value="this_quarter">This Quarter</option>
                <option value="this_year">This Year</option>
              </select>
              <button class="btn btn-secondary btn-sm" onclick="alert('Export functionality not yet implemented.')"><i class="fas fa-download"></i> Export</button>
            </div>
          </div>

          <!-- KPI Cards -->
          <div class="kpi-grid">
            <div class="kpi-card">
              <div class="kpi-icon revenue"><i class="fas fa-rupee-sign"></i></div>
              <div class="kpi-content">
                <h3>Total Revenue</h3>
                <div class="kpi-value" id="monthlyRevenue">₹0</div>
                <div class="kpi-change positive" id="revenueChange">+0%</div>
              </div>
            </div>
            <div class="kpi-card">
              <div class="kpi-icon customers"><i class="fas fa-users"></i></div>
              <div class="kpi-content">
                <h3>Active Customers</h3>
                <div class="kpi-value" id="totalCustomers">0</div>
                <div class="kpi-change positive" id="customersChange">+0</div>
              </div>
            </div>
            <div class="kpi-card">
              <div class="kpi-icon products"><i class="fas fa-box-open"></i></div>
              <div class="kpi-content">
                <h3>Total Products</h3>
                <div class="kpi-value" id="totalProducts">0</div>
                <div class="kpi-subtext" id="lowStockAlert" style="cursor:pointer;" onclick="showLowStockProducts()">0 low stock</div>
              </div>
            </div>
            <div class="kpi-card">
              <div class="kpi-icon invoices"><i class="fas fa-file-alt"></i></div>
              <div class="kpi-content">
                <h3>Pending Amount</h3>
                <div class="kpi-value" id="pendingAmount">₹0</div>
                <div class="kpi-subtext" id="pendingInvoices" style="cursor:pointer;" onclick="navigateToSection('invoiceManagementSection')">0 invoices</div>
              </div>
            </div>
          </div>

          <!-- Charts and Recent Activity Row -->
          <div class="dashboard-row">
            <div class="chart-container revenue-chart-container">
              <div class="chart-header">
                <h3>Revenue Trend</h3>
                 <div class="chart-controls">
                    <button class="chart-time-btn active" data-period="daily">Daily</button>
                    <button class="chart-time-btn" data-period="weekly">Weekly</button>
                    <button class="chart-time-btn" data-period="monthly">Monthly</button>
                </div>
              </div>
              <div class="chart-canvas-wrapper">
                <canvas id="revenueChart"></canvas>
              </div>
            </div>

            <div class="dashboard-column">
              <div class="chart-container category-chart-container">
                <div class="chart-header"><h3>Top Selling Products</h3> <a href="#" class="view-all-link" onclick="generateAndDisplayReport('top_products'); navigateToSection('reportsSection'); return false;">View all</a></div>
                <div class="chart-canvas-wrapper" style="min-height: 150px; display:flex; align-items:center; justify-content:center;">
                  <p id="topSellingPlaceholder" class="text-muted">No product sales data available</p>
                  <canvas id="categoryChart" style="display:none;"></canvas>
                </div>
              </div>

              <div class="recent-activity-container">
                <div class="activity-header">
                  <h3>Recent Transactions</h3>
                  <a href="#" class="view-all-link" onclick="navigateToSection('allTransactionsSection'); return false;">View all</a>
                </div>
                <div class="activity-list" id="recentActivityList">
                   <div class="activity-item-placeholder">No transactions available</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Today's Sales & System Status Row -->
          <div class="dashboard-row">
            <div class="info-card">
              <h3>Today's Sales</h3>
              <div class="today-sales-item"><span>Revenue</span><strong id="todayRevenue">₹0</strong></div>
              <div class="today-sales-item"><span>Orders</span><strong id="todayOrders">0</strong></div>
              <div class="today-sales-item"><span>Avg. Order Value</span><strong id="todayAvgOrder">₹0</strong></div>
            </div>
            <div class="info-card">
                <h3>System Status</h3>
                <div class="system-status-item"><span>Database</span><span class="status-indicator operational">Operational</span></div>
                <div class="system-status-item"><span>API</span><span class="status-indicator operational">Operational</span></div>
                <div class="system-status-item"><span>Storage</span><span class="status-indicator warning" onclick="alert('Storage usage is high. Consider backups and cleanup.')" style="cursor:pointer;">High Usage</span></div>
            </div>
          </div>
        </section>

        <!-- In index.html -->
<section id="customerManagementSection" class="app-section table-container" style="display: none;">
  <h2>Customer Management</h2>
  <button class="btn btn-primary" onclick="openUserModal()">+ Add New Customer</button>
  <table id="customerTable">
    <thead>
      <tr>
        <!-- THIS IS THE CHANGE -->
        <th>S.No.</th>
        <th>Name</th>
        <th>Opening Bal. (₹)</th>
        <th>Current Receivable (₹)</th>
        <th>Loan Outstanding (₹)</th>
        <th>Chit Net Position (₹)</th>
        <th>Joined</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="customerTableBody"></tbody>
  </table>
</section>

        <section id="supplierManagementSection" class="app-section table-container" style="display: none;">
          <h2>Supplier Management</h2>
          <button class="btn btn-primary" onclick="openLenderModal(null, 'Supplier')">+ Add New Supplier</button>
          <table id="supplierTable">
            <thead><tr><th>ID</th><th>Supplier Name</th><th>Contact</th><th>Current Payable (₹)</th><th>Notes</th><th>Actions</th></tr></thead>
            <tbody id="supplierTableBody"></tbody>
          </table>
        </section>

        <section id="inventoryManagementSection" class="app-section table-container" style="display: none;">
          <h2>Inventory Management</h2>
          <button class="btn btn-primary" onclick="openProductModal()">+ Add New Product</button>
          <table id="productTable">
            <thead>
              <tr>
                <th>ID</th>
                <th>Product Name</th>
                <th>SKU</th>
                <th>Preferred Supplier</th>
                <th class="num">Pref. Purchase Price (₹)</th>
                <th class="num">Avg. Cost Price (₹)</th>
                <th class="num">Sale Price (₹)</th>
                <th>Current Stock</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="productTableBody"></tbody>
          </table>
        </section>

        <section id="invoiceManagementSection" class="app-section table-container" style="display: none;">
          <h2>Invoices</h2>
          <button class="btn btn-primary" onclick="openInvoiceModal()">+ New Invoice</button>
          <table id="invoiceTable">
            <thead>
              <tr>
                <th>Invoice #</th>
                <th>Customer</th>
                <th>Type</th>
                <th>Inv. Date</th>
                <th>Due Date</th>
                <th class="num">Total (₹)</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="invoiceTableBody"></tbody>
          </table>
        </section>

        <section id="allTransactionsSection" class="app-section table-container" style="display: none;">
          <h2>All Transactions</h2>
           <button class="btn btn-primary" onclick="openTransactionModal(null)">+ Add Transaction</button>
          <table>
            <thead><tr><th>ID</th><th>User/Entity</th><th>Amount (₹)</th><th>Description</th><th>Category</th><th>Date</th><th>Actions</th></tr></thead>
            <tbody id="transactionTable"></tbody>
          </table>
        </section>

        <section id="ledgersSection" class="app-section table-container" style="display: none;">
          <h2>Business Ledgers</h2>
          <div class="ledger-tabs">
              <button class="btn btn-secondary ledger-tab-btn active" onclick="showLedger('cash')">Cash Ledger</button>
              <button class="btn btn-secondary ledger-tab-btn" onclick="showLedger('bank')">Bank Ledger</button>
          </div>

          <div id="cashLedgerContent" class="ledger-content">
              <h3>Cash Ledger</h3>
              <div class="ledger-controls">
                  <label for="cashLedgerDate">Date:</label>
                  <input type="date" id="cashLedgerDate" class="form-control-sm">
                  <button onclick="loadCashLedger()" class="btn btn-primary btn-sm"><i class="fas fa-sync-alt"></i> Load</button>
                  <button onclick="printLedger('cashLedgerTable', 'Cash Ledger')" class="btn btn-secondary btn-sm"><i class="fas fa-print"></i> Print</button>
              </div>
              <table id="cashLedgerTable">
                <thead><tr><th>Date</th><th>User/Entity</th><th>Description</th><th>Category</th><th>Cash In (₹)</th><th>Cash Out (₹)</th><th>Cash Balance (₹)</th></tr></thead>
                <tbody></tbody>
                <tfoot></tfoot>
              </table>
          </div>

          <div id="bankLedgerContent" class="ledger-content" style="display: none;">
              <h3>Bank Ledger</h3>
               <div class="ledger-controls">
                  <label for="bankLedgerDate">Date:</label>
                  <input type="date" id="bankLedgerDate" class="form-control-sm">
                  <button onclick="loadBankLedger()" class="btn btn-primary btn-sm"><i class="fas fa-sync-alt"></i> Load</button>
                  <button onclick="printLedger('bankLedgerTable', 'Bank Ledger')" class="btn btn-secondary btn-sm"><i class="fas fa-print"></i> Print</button>
              </div>
              <table id="bankLedgerTable">
                <thead><tr><th>Date</th><th>User/Entity</th><th>Description</th><th>Category</th><th>Bank In (₹)</th><th>Bank Out (₹)</th><th>Bank Balance (₹)</th></tr></thead>
                <tbody></tbody>
                <tfoot></tfoot>
              </table>
          </div>
        </section>

        <section id="businessFinanceSection" class="app-section table-container" style="display: none;">
          <h2>Business's External Finance Agreements</h2>
          <div class="section-actions">
              <button class="btn btn-primary" onclick="openCreateBusinessChitLoanAgreementModal()">+ Create Agreement</button>
              <button class="btn btn-success" onclick="openTransactionModalForBusinessExternal()">+ Add Tx For Agreement</button>
          </div>
          <table id="businessExternalFinanceTable" class="summary-table">
              <thead><tr><th>Provider/Entity Name</th><th>Type</th><th class="num">Total Amt (₹)</th><th>Interest Rate (%)</th><th class="num">Interest Payable (₹)</th><th class="num">Net Paid/Received (₹)</th><th class="num">Net Balance (₹)</th><th>Actions</th></tr></thead>
              <tbody id="businessExternalFinanceTableBody"></tbody>
          </table>
          <hr>
          <h3>External Entities (Banks, Lenders, etc.)</h3>
          <div class="section-actions"><button class="btn btn-primary" onclick="openLenderModal(null, 'Financial')">+ Add Financial Entity</button></div>
          <table id="lendersTable">
              <thead><tr><th>ID</th><th>Name</th><th>Type</th><th>Contact</th><th>Phone</th><th>Notes</th><th>Actions</th></tr></thead>
              <tbody id="lendersTableBody"></tbody>
          </table>
        </section>

        <section id="reportsSection" class="app-section" style="display: none;">
          <div class="report-header">
              <h2>Reports & Analytics</h2>
              <div class="report-main-controls">
                  <label for="reportPeriodMonth">Select Period:</label>
                  <input type="month" id="reportPeriodMonth" class="form-control-sm">
              </div>
          </div>
        
          <div class="report-card-grid">
              <div class="report-card-item" onclick="generateAndDisplayReport('turnover_report')">
                <div class="rc-icon" style="background-color: #007bff;"><i class="fas fa-chart-line"></i></div>
                <div class="rc-content">
                    <h4>Turnover Report</h4>
                    <p>Track your gross sales performance over the selected period.</p>
                </div>
              </div>
              <div class="report-card-item" onclick="generateAndDisplayReport('pnl_summary')">
                  <div class="rc-icon pnl"><i class="fas fa-balance-scale"></i></div>
                  <div class="rc-content">
                      <h4>Profit & Loss Summary</h4>
                      <p>Analyze your revenue, costs, and profitability.</p>
                  </div>
              </div>
              <div class="report-card-item" onclick="generateAndDisplayReport('cash_flow')">
                  <div class="rc-icon cashflow"><i class="fas fa-exchange-alt"></i></div>
                  <div class="rc-content">
                      <h4>Cash Flow Analysis</h4>
                      <p>Track your monthly income vs. expenses.</p>
                  </div>
              </div>
              <div class="report-card-item" onclick="generateAndDisplayReport('top_customers')">
                  <div class="rc-icon customers"><i class="fas fa-star"></i></div>
                  <div class="rc-content">
                      <h4>Top Customers</h4>
                      <p>Identify your most valuable customers by revenue.</p>
                  </div>
              </div>
              <div class="report-card-item" onclick="generateAndDisplayReport('top_products')">
                  <div class="rc-icon products"><i class="fas fa-trophy"></i></div>
                  <div class="rc-content">
                      <h4>Top Selling Products</h4>
                      <p>See which products are your best performers.</p>
                  </div>
              </div>
          </div>
        
          <div id="reportDisplayArea" class="report-display-container" style="display:none;">
              <!-- Report content will be injected here by JavaScript -->
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- Modals -->
  <div id="userModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
      <span class="close" onclick="closeUserModal()">×</span><h2>Customer</h2>
      <form id="userForm">
        <div class="form-row">
            <div class="form-group"><label for="username">Customer Name*</label><input id="username" class="form-control" required /></div>
            <div class="form-group"><label for="email">Email</label><input id="email" type="email" class="form-control" /></div>
        </div>
        <div class="form-row">
            <div class="form-group"><label for="phone">Phone</label><input id="phone" class="form-control" /></div>
            <div class="form-group"><label for="company">Company</label><input id="company" class="form-control" /></div>
        </div>
        <div class="form-group"><label for="address_line1">Address Line 1</label><input id="address_line1" class="form-control" /></div>
        <div class="form-group"><label for="address_line2">Address Line 2</label><input id="address_line2" class="form-control" /></div>
        <div class="form-row">
            <div class="form-group flex-2"><label for="city_pincode">City - Pincode</label><input id="city_pincode" class="form-control" /></div>
            <div class="form-group flex-1"><label for="state">State</label><input id="state" class="form-control" /></div>
        </div>
         <div class="form-row">
            <div class="form-group flex-2"><label for="gstin">GSTIN</label><input id="gstin" class="form-control" /></div>
            <div class="form-group flex-1"><label for="state_code">State Code</label><input id="state_code" class="form-control" /></div>
        </div>
        <div class="form-group">
            <label for="balance">Opening Receivable (+ve) / Payable (-ve) (₹)*</label>
            <input id="balance" class="form-control" type="number" step="0.01" required />
        </div>
        <button type="submit" class="btn btn-primary">Confirm</button>
      </form>
    </div>
  </div>

  <div id="transactionModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeTransactionModal()">×</span>
      <h2 id="transactionModalTitle">Transaction</h2>
      <form id="transactionForm">
        <div class="form-group radio-group">
            <label>Transaction For:</label>
            <div>
                <input type="radio" id="txPartyTypeCustomer" name="txPartyType" value="customer" onchange="toggleTxPartyDropdowns()" checked>
                <label for="txPartyTypeCustomer">Customer</label>
            </div>
            <div>
                <input type="radio" id="txPartyTypeLender" name="txPartyType" value="lender" onchange="toggleTxPartyDropdowns()">
                <label for="txPartyTypeLender">Lender/External Entity</label>
            </div>
        </div>

        <div class="form-group"><select id="transaction_user_id" class="form-control"><option value="">Select Customer...</option></select></div>
        <div class="form-group" style="display:none;"><select id="transaction_lender_id" class="form-control"><option value="">Select Supplier/External Entity...</option></select></div>
        <div class="form-group" style="display:none;"><select id="transaction_agreement_id" class="form-control"><option value="">Select Business Agreement...</option></select></div>

        <div class="form-group"><label for="category">Category:</label>
        <select id="category" class="form-control" required><option value="">Select Category...</option></select></div>
        
        <div class="form-group radio-group" id="paymentModeGroup" style="display:none;">
            <label style="margin-right: 10px; margin-bottom:0;">Payment Mode:</label>
            <div>
                <input type="radio" id="txPayModeCash" name="txPaymentMode" value="Cash">
                <label for="txPayModeCash">Cash</label>
            </div>
            <div>
                <input type="radio" id="txPayModeBank" name="txPaymentMode" value="Bank">
                <label for="txPayModeBank">Bank</label>
            </div>
            <div>
                <input type="radio" id="txPayModeCredit" name="txPaymentMode" value="On Credit">
                <label for="txPayModeCredit">On Credit</label>
            </div>
        </div>

        <div id="transactionLineItemsSection" style="display:none;">
            <hr><h3 class="modal-subtitle">Line Items</h3>
            <table id="txLineItemsTable" class="modal-line-item-table">
                <thead><tr><th style="width: 45%;">Product</th><th style="width: 15%;">Qty</th><th style="width: 20%;">Unit Price</th><th style="width: 15%;">Total</th><th style="width: 5%;"></th></tr></thead>
                <tbody id="txLineItemsTableBody"></tbody>
            </table>
            <button type="button" class="btn btn-secondary btn-sm" onclick="addTxLineItemRow()">+ Add Item</button>
            <p class="line-items-total">Line Items Total: ₹<span id="txLineItemsGrandTotal">0.00</span></p>
            <hr>
        </div>

        <div class="form-group">
            <label for="amount" id="amountLabel">Amount (₹):</label>
            <input id="amount" class="form-control" placeholder="Amount / Total Sale" type="number" step="0.01" min="0" required />
        </div>

        <div id="initialPaymentGroup" style="display:none;" class="form-group">
            <label for="initial_payment_amount">Initial Payment Received (₹):</label>
            <input type="number" id="initial_payment_amount" class="form-control" step="0.01" min="0" placeholder="0.00">
        </div>

        <div class="form-group"><label for="description">Description:</label>
        <input id="description" class="form-control" placeholder="Description" /></div>

        <div class="form-group"><label for="date">Date:</label>
        <input type="date" id="date" class="form-control" required /></div>

        <button type="submit" class="btn btn-primary">Confirm</button>
      </form>
    </div>
  </div>

  <div id="lenderModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeLenderModal()">×</span>
        <h2 id="lenderModalTitle">External Entity</h2>
        <form id="lenderForm">
            <input type="hidden" id="lenderId">
            <div class="form-group"><input id="lenderName" class="form-control" placeholder="Entity Name (Supplier, Bank, etc.)" required /></div>
            <div class="form-group"><label for="lenderEntityType">Entity Type:</label>
            <select id="lenderEntityType" class="form-control" onchange="toggleInitialPayableField()">
                <option value="General">General</option><option value="Supplier">Supplier</option><option value="Bank">Bank</option>
                <option value="Chit Provider">Chit Provider</option><option value="Individual Lender">Individual Lender</option>
            </select></div>
            <div id="initialPayableGroup" style="display:none;" class="form-group">
                <label for="lenderInitialPayable">Initial Payable to this Supplier (₹):</label>
                <input type="number" id="lenderInitialPayable" class="form-control" step="0.01" value="0.00">
            </div>
            <div class="form-group"><input id="lenderContactPerson" class="form-control" placeholder="Contact Person (Optional)" /></div>
            <div class="form-group"><input id="lenderPhone" type="tel" class="form-control" placeholder="Phone" /></div>
            <div class="form-group"><input id="lenderEmail" type="email" class="form-control" placeholder="Email" /></div>
            <div class="form-group"><textarea id="lenderNotes" class="form-control" placeholder="Notes"></textarea></div>
            <button type="submit" class="btn btn-primary">Save Entity</button>
        </form>
    </div>
</div>

  <div id="businessChitLoanAgreementModal" class="modal"><div class="modal-content"><span class="close" onclick="closeBusinessChitLoanAgreementModal()">×</span><h2 id="businessChitLoanAgreementModalTitle">New Business Finance Agreement</h2><form id="businessChitLoanAgreementForm"><input type="hidden" id="agreementId"><div class="form-group"><label for="agreement_entity_id">With External Entity:</label><select id="agreement_entity_id" class="form-control" required></select></div><div class="form-group"><label for="agreement_type">Agreement Type:</label><select id="agreement_type" class="form-control" required><option value="">Select Type...</option><option value="chit_participation">Chit Fund Participation (Biz)</option><option value="loan_taken_by_biz">Loan Taken by Business</option><option value="loan_given_by_biz">Loan Given by Business</option></select></div><div class="form-group"><label for="agreement_total_amount">Total Chit Value / Loan Principal (₹):</label><input id="agreement_total_amount" type="number" step="0.01" class="form-control" required /></div> <div class="form-group"><label for="agreement_interest_rate">Interest Rate (% p.m.):</label><input id="agreement_interest_rate" type="number" step="0.01" class="form-control" placeholder="e.g., 5" /></div> <div class="form-group"><label for="agreement_start_date">Start Date:</label><input id="agreement_start_date" type="date" class="form-control" required /></div><div class="form-group"><textarea id="agreement_details" class="form-control" placeholder="Details (e.g., Chit Group ID, Loan Terms, Installment Amt)"></textarea></div><button type="submit" class="btn btn-primary">Save Agreement</button></form></div></div>
  
  <div id="userTransactionHistoryModal" class="modal"><div class="modal-content" style="max-width: 800px;"><span class="close" onclick="closeUserTransactionHistoryModal()">×</span><h2 id="userTransactionHistoryModalTitle">Transaction History</h2><div class="filter-controls"><label for="userTxHistoryCategoryFilter">Filter by Category Group:</label><select id="userTxHistoryCategoryFilter" class="form-control-sm"><option value="all">All Transactions</option><option value="customer_revenue">Sales/Service Revenue</option><option value="customer_payment">Payments from Customer</option><option value="customer_loan">Customer Loans</option><option value="customer_chit">Customer Chits</option></select></div><table id="userTransactionHistoryTable"><thead><tr><th>Date</th><th>Category</th><th>Description</th><th>Amount (₹)</th></tr></thead><tbody id="userTransactionHistoryTableBody"></tbody></table></div></div>

  <div id="entityTransactionHistoryModal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
      <span class="close" onclick="closeEntityTransactionHistoryModal()">×</span>
      <h2 id="entityTransactionHistoryModalTitle">Transaction History</h2>
      <table id="entityTransactionHistoryTable">
        <thead>
          <tr>
            <th>Date</th>
            <th>Category</th>
            <th>Description</th>
            <th>Amount (₹)</th>
            <th>Related To (User/Entity)</th>
          </tr>
        </thead>
        <tbody id="entityTransactionHistoryTableBody"></tbody>
      </table>
    </div>
  </div>

  <div id="productModal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
      <span class="close" onclick="closeProductModal()">×</span>
      <h2 id="productModalTitle">Add New Product</h2>
      <form id="productForm">
        <input type="hidden" id="productId">
        <div class="form-group"><label for="productName">Product Name*</label><input id="productName" class="form-control" required /></div>
        <div class="form-row">
            <div class="form-group"><label for="productSku">SKU</label><input id="productSku" class="form-control" /></div>
            <div class="form-group"><label for="productHsnAcs">HSN/ACS Code</label><input id="productHsnAcs" class="form-control" /></div>
        </div>
        <div class="form-group"><label for="productDescription">Description</label><textarea id="productDescription" class="form-control"></textarea></div>
        <div class="form-row">
            <div class="form-group"><label for="productCostPrice">Avg. Cost Price (₹)</label><input id="productCostPrice" type="number" step="0.01" class="form-control"/></div>
            <div class="form-group"><label for="productSalePrice">Sale Price (₹)*</label><input id="productSalePrice" type="number" step="0.01" class="form-control" required /></div>
        </div>
         <div class="form-row">
            <div class="form-group"><label for="productCurrentStock">Current Stock*</label><input id="productCurrentStock" type="number" step="1" class="form-control" required /></div>
            <div class="form-group"><label for="productUnitOfMeasure">Unit</label><input id="productUnitOfMeasure" class="form-control" value="pcs" /></div>
        </div>
        <div class="form-row">
            <div class="form-group"><label for="productLowStockThreshold">Low Stock Alert At</label><input id="productLowStockThreshold" type="number" step="1" class="form-control" value="0" /></div>
            <div class="form-group"><label for="productReorderLevel">Reorder Level</label><input id="productReorderLevel" type="number" step="1" class="form-control" value="0" /></div>
        </div>
        <hr>
        <h3 class="modal-subtitle">Suppliers for this Product</h3>
        <div id="productSuppliersList" class="table-container modal-table-container">
            <table id="productSuppliersTable">
                <thead><tr><th>Supplier</th><th>Their SKU</th><th>Their Price (₹)</th><th>Preferred</th><th>Actions</th></tr></thead>
                <tbody id="productSuppliersTableBody"></tbody>
            </table>
        </div>
        <button type="button" class="btn btn-secondary btn-sm" onclick="openProductSupplierLinkModal()">+ Link Supplier</button>
        <hr>
        <button type="submit" class="btn btn-primary">Save Product Details</button>
      </form>
    </div>
  </div>

  <div id="productSupplierLinkModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <span class="close" onclick="closeProductSupplierLinkModal()">×</span>
        <h2 id="productSupplierLinkModalTitle">Link Supplier to Product</h2>
        <form id="productSupplierLinkForm">
            <input type="hidden" id="productSupplierLinkId"><input type="hidden" id="linkModalProductId">
            <div class="form-group"><label for="linkSupplierId">Supplier*:</label><select id="linkSupplierId" class="form-control" required></select></div>
            <div class="form-group"><label for="linkSupplierSku">Supplier's SKU:</label><input type="text" id="linkSupplierSku" class="form-control"></div>
            <div class="form-group"><label for="linkSupplierPurchasePrice">Purchase Price (₹):</label><input type="number" id="linkSupplierPurchasePrice" step="0.01" class="form-control" placeholder="0.00"></div>
            <div class="form-group"><label for="linkSupplierLeadTime">Lead Time (days):</label><input type="number" id="linkSupplierLeadTime" step="1" class="form-control" placeholder="e.g., 7"></div>
            <div class="form-group checkbox-group">
                <input type="checkbox" id="linkIsPreferredSupplier"><label for="linkIsPreferredSupplier">Preferred Supplier</label>
            </div>
            <div class="form-group"><label for="linkSupplierNotes">Notes:</label><textarea id="linkSupplierNotes" class="form-control" placeholder="Notes for this supplier/product"></textarea></div>
            <button type="submit" class="btn btn-primary">Save Link</button>
        </form>
    </div>
  </div>

  <div id="invoiceModal" class="modal">
    <div class="modal-content" style="max-width: 950px; max-height: 90vh; overflow-y: auto;">
      <span class="close" onclick="closeInvoiceModal()">×</span>
      <h2 id="invoiceModalTitle">New Invoice</h2>
      <form id="invoiceForm">
        <input type="hidden" id="invoiceId">
        <fieldset> <legend>Invoice Details</legend>
            <div class="form-row">
                <div class="form-group flex-2 invoice-number-group">
                    <label for="inv_invoice_number_display">Invoice Number*:</label>
                    <input type="text" id="inv_invoice_number_display" class="form-control" placeholder="Enter or Generate" required>
                    <button type="button" class="btn btn-sm btn-info" onclick="suggestNextInvoiceNumber()">Suggest</button>
                </div>
                <div class="form-group flex-1"><label for="inv_invoice_type">Invoice Type*:</label>
                    <select id="inv_invoice_type" class="form-control" required>
                        <option value="TAX_INVOICE">Tax Invoice (GST)</option><option value="BILL_OF_SUPPLY">Bill of Supply (No GST)</option>
                        <option value="PARTY_BILL">Party Bill (Non-GST, w/Returns)</option><option value="NON_GST_RETAIL_BILL">Retail Bill (Non-GST)</option>
                    </select>
                </div>
            </div>
             <div class="form-row">
                 <div class="form-group"><label for="inv_invoice_date">Invoice Date*:</label><input type="date" id="inv_invoice_date" class="form-control" required /></div>
                <div class="form-group"><label for="inv_due_date">Due Date*:</label><input type="date" id="inv_due_date" class="form-control" required /></div>
                <div class="form-group"><label for="inv_date_of_supply">Date of Supply:</label><input type="date" id="inv_date_of_supply" class="form-control" /></div>
            </div>
        </fieldset>
        <fieldset><legend>Customer (Billed To)</legend>
            <div class="form-group"><label for="inv_customer_id">Select Customer*:</label><select id="inv_customer_id" class="form-control" required></select></div>
            <input type="text" id="inv_customer_name_display" class="form-control" placeholder="Customer Name (auto)" readonly>
            <textarea id="inv_customer_address_display" class="form-control" placeholder="Customer Address (auto)" readonly rows="2"></textarea>
            <div class="form-row">
                <div class="form-group"><input type="text" id="inv_customer_gstin_display" class="form-control" placeholder="Customer GSTIN (auto)" readonly></div>
                <div class="form-group"><input type="text" id="inv_customer_statecode_display" class="form-control" placeholder="Customer State Code (auto)" readonly></div>
            </div>
        </fieldset>
        <fieldset><legend>Consignee (Shipped To) <input type="checkbox" id="inv_same_as_customer"> <small>Same as Customer</small></legend>
            <div id="invConsigneeFields">
                <div class="form-group"><label for="inv_consignee_name">Consignee Name:</label><input type="text" id="inv_consignee_name" class="form-control"></div>
                <div class="form-group"><label for="inv_consignee_address_line1">Address Line 1:</label><input type="text" id="inv_consignee_address_line1" class="form-control"></div>
                <div class="form-group"><label for="inv_consignee_address_line2">Address Line 2:</label><input type="text" id="inv_consignee_address_line2" class="form-control"></div>
                <div class="form-row">
                    <div class="form-group flex-2"><label for="inv_consignee_city_pincode">City - Pincode:</label><input type="text" id="inv_consignee_city_pincode" class="form-control"></div>
                    <div class="form-group flex-1"><label for="inv_consignee_state">State:</label><input type="text" id="inv_consignee_state" class="form-control"></div>
                </div>
                <div class="form-row">
                    <div class="form-group flex-2"><label for="inv_consignee_gstin">GSTIN:</label><input type="text" id="inv_consignee_gstin" class="form-control"></div>
                    <div class="form-group flex-1"><label for="inv_consignee_state_code">State Code:</label><input type="text" id="inv_consignee_state_code" class="form-control"></div>
                </div>
            </div>
        </fieldset>
        <fieldset><legend>Supply & Transport</legend>
            <div class="form-row">
                <div class="form-group"><label for="inv_transportation_mode">Mode:</label><input type="text" id="inv_transportation_mode" class="form-control"></div>
                <div class="form-group"><label for="inv_vehicle_number">Vehicle No.:</label><input type="text" id="inv_vehicle_number" class="form-control"></div>
            </div>
            <div class="form-row">
                 <div class="form-group"><label for="inv_place_of_supply_state">Place of Supply (State):</label><input type="text" id="inv_place_of_supply_state" class="form-control"></div>
                <div class="form-group"><label for="inv_place_of_supply_state_code">State Code:</label><input type="text" id="inv_place_of_supply_state_code" class="form-control"></div>
            </div>
             <div class="form-row">
                <div class="form-group"><label for="inv_reverse_charge">Reverse Charge:</label><select id="inv_reverse_charge" class="form-control"><option value="No">No</option><option value="Yes">Yes</option></select></div>
                <div class="form-group"><label for="inv_bundles_count">Bundles:</label><input type="number" id="inv_bundles_count" class="form-control" min="0" step="1"></div>
            </div>
        </fieldset>
        <fieldset><legend>Line Items</legend>
            <table id="invLineItemsTable" class="modal-line-item-table">
                <thead><tr><th style="width: 30%;">Product/Service</th><th style="width: 12%;">HSN/ACS</th><th style="width: 8%;">UoM</th><th style="width: 10%;" class="num">Qty</th><th style="width: 12%;" class="num">Rate</th><th style="width: 12%;" class="num">Discount</th><th style="width: 12%;" class="num">Taxable Amt</th><th style="width: 4%;"></th></tr></thead>
                <tbody id="invLineItemsTableBody"></tbody>
            </table>
            <button type="button" class="btn btn-secondary btn-sm" onclick="addInvLineItemRow()">+ Add Item</button>
        </fieldset>
        <div id="invGstSection"> <hr>
            <div class="form-row tax-rate-row">
                <div><label for="inv_cgst_rate_overall">CGST (%):</label><input type="number" id="inv_cgst_rate_overall" step="0.01" class="form-control inv-tax-rate" value="2.5" oninput="updateInvTotals()"></div>
                <div><label for="inv_sgst_rate_overall">SGST (%):</label><input type="number" id="inv_sgst_rate_overall" step="0.01" class="form-control inv-tax-rate" value="2.5" oninput="updateInvTotals()"></div>
                <div><label for="inv_igst_rate_overall">IGST (%):</label><input type="number" id="inv_igst_rate_overall" step="0.01" class="form-control inv-tax-rate" value="0" oninput="updateInvTotals()"></div>
            </div>
        </div>
        <div id="invPartyBillReturnsSection" style="display:none;" class="form-group">
            <label for="inv_party_bill_returns_amount">Party Bill Returns Amount (₹):</label>
            <input type="number" id="inv_party_bill_returns_amount" class="form-control" step="0.01" min="0" value="0" oninput="updateInvTotals()">
        </div>
        <div class="invoice-totals-summary">
            <p>Subtotal (Taxable): ₹<span id="invSubtotal">0.00</span></p>
            <div id="invGstSummarySection">
                <p>Total CGST: ₹<span id="invTotalCGST">0.00</span></p><p>Total SGST: ₹<span id="invTotalSGST">0.00</span></p><p>Total IGST: ₹<span id="invTotalIGST">0.00</span></p>
            </div>
            <p id="invReturnsDisplay" style="display:none;">Less Returns: ₹<span id="invReturnsAmountDisplay">0.00</span></p>
            <h4>Grand Total: ₹<span id="invGrandTotal">0.00</span></h4>
        </div>
        <div class="form-group"><label for="inv_amount_in_words">Amount in Words:</label><input type="text" id="inv_amount_in_words" class="form-control" placeholder="e.g., THREE LAKH TWENTY EIGHT THOUSAND..." oninput="this.value = this.value.toUpperCase()"></div>
        <div class="form-row payment-status-row">
            <div class="form-group"><label for="inv_status">Status*:</label>
                <select id="inv_status" class="form-control" required>
                    <option value="Draft">Draft</option><option value="Sent">Sent</option><option value="Paid">Paid</option>
                    <option value="Partially Paid">Partially Paid</option><option value="Overdue">Overdue</option><option value="Void">Void</option>
                </select>
            </div>
            <div class="form-group"><label>Already Paid (₹):</label>
                <p class="cumulative-paid-display">₹<span id="inv_cumulative_paid_display">0.00</span></p>
            </div>
            <div class="form-group"><label for="inv_payment_being_made_now">Payment with this Save (₹):</label><input type="number" id="inv_payment_being_made_now" class="form-control" step="0.01" min="0" value="0.00" placeholder="0.00"></div>
        </div>
        <div class="form-group"><label for="inv_notes">Notes/Terms & Conditions:</label><textarea id="inv_notes" class="form-control" placeholder="Payment terms, additional notes..."></textarea></div>
        <hr>
        <button type="submit" class="btn btn-primary">Save Invoice</button>
        <button type="button" class="btn btn-info" onclick="printCurrentInvoice()">Print Invoice</button>
      </form>
    </div>
  </div>

  <div id="repayLoanModal" class="modal">
    <div class="modal-content" style="max-width: 550px;">
      <span class="close" onclick="closeRepayLoanModal()">×</span>
      <h2 id="repayLoanModalTitle">Repay Loan</h2>
      <form id="repayLoanForm">
        <input type="hidden" id="repay_agreement_id">
        
        <div class="form-row">
            <div class="form-group">
                <label>Outstanding Principal (₹):</label>
                <p class="cumulative-paid-display" id="repay_outstanding_principal">0.00</p>
            </div>
            <div class="form-group">
                <label>Accrued Interest Payable (₹):</label>
                <p class="cumulative-paid-display" id="repay_interest_payable">0.00</p>
            </div>
        </div>
  
        <div class="form-group">
            <label for="repay_payment_amount">Payment Amount (₹)*</label>
            <input type="number" id="repay_payment_amount" class="form-control" step="0.01" min="0.01" required>
        </div>
  
        <div class="form-group">
            <label>How to apply this payment?</label>
            <div class="radio-group" style="justify-content: space-around;">
                <div><input type="radio" name="repay_payment_type" id="repay_type_combined" value="combined" onchange="toggleRepayOptions()" checked><label for="repay_type_combined">Combined (Interest First)</label></div>
                <div><input type="radio" name="repay_payment_type" id="repay_type_interest" value="interest" onchange="toggleRepayOptions()"><label for="repay_type_interest">Interest Only</label></div>
                <div><input type="radio" name="repay_payment_type" id="repay_type_principal" value="principal" onchange="toggleRepayOptions()"><label for="repay_type_principal">Principal Only</label></div>
            </div>
        </div>
  
        <div class="form-group">
            <label>Payment Method*</label>
            <div class="radio-group">
                 <div><input type="radio" name="repay_payment_method" id="repay_method_bank" value="Bank" checked><label for="repay_method_bank">From Bank</label></div>
                 <div><input type="radio" name="repay_payment_method" id="repay_method_cash" value="Cash"><label for="repay_method_cash">From Cash</label></div>
            </div>
        </div>
  
        <div class="form-group">
            <label for="repay_date">Payment Date*</label>
            <input type="date" id="repay_date" class="form-control" required>
        </div>
        
        <button type="submit" class="btn btn-success">Process Payment</button>
      </form>
    </div>
  </div>

  <div id="loanDetailsModal" class="modal">
    <div class="modal-content" style="max-width: 750px;">
        <span class="close" onclick="closeLoanDetailsModal()">×</span>
        <h2 id="loanDetailsTitle">Loan Details</h2>
        <div id="loanDetailsHeaderInfo" style="margin-bottom: 15px; background-color: #f8f9fa; padding: 10px; border-radius: 6px;">
        </div>

        <h3 class="modal-subtitle">Monthly Interest Breakdown</h3>
        <div class="table-container modal-table-container">
            <table id="loanInterestBreakdownTable">
                <thead>
                    <tr>
                        <th>Month</th>
                        <th class="num">Interest Due (₹)</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="loanInterestBreakdownTableBody">
                </tbody>
            </table>
        </div>

        <h3 class="modal-subtitle">Payment History</h3>
        <div class="table-container modal-table-container">
            <table id="loanPaymentHistoryTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Category</th>
                        <th class="num">Amount (₹)</th>
                    </tr>
                </thead>
                <tbody id="loanPaymentHistoryTableBody">
                </tbody>
            </table>
        </div>
    </div>
  </div>

</body>
</html>